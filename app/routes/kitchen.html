<!DOCTYPE html>
<html>
<style>
	table, th, td {
		border: 1px solid black;
		border-collapse: collapse;
	}
	
	th, td {
		padding: 5px;
		text-align: left;
	}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<body>

<div ng-app="myApp" ng-controller="customersCtrl">
	<h3>Sample Kitchen Display</h3>
	<table style="width:50%">
		<tr>
			<th>Name</th>
			<th>Quantity</th>
			<th>Created-till-now</th>
			<th>Predicted</th>
			<th>Status</th>
		</tr>
		<tr ng-repeat="x in kitchens | filter:_id">
			<td>{{ x.product.productName }}</td>
			<td>{{ x.quantity }}</td>
			<td>{{ x.produced }}</td>
			<td>{{ x.product.predictedQuantity }}</td>
			<td>
				<button type="button" ng-click="orderDone(x._id)">Done!</button>
			</td>
		</tr>
	</table>
	<h3>Sample Report
		<button type="button" ng-click="report()">Generate Report</button>
	</h3>
	
	<table>
		<tr>
			<th>Dish name</th>
			<th>Produced</th>
			<th>Predicted</th>
		</tr>
		<tr ng-repeat="x in kitchensRPT | filter:_id">
			<td>{{ x.product.productName }}</td>
			<td>{{ x.produced }}</td>
			<td>{{ x.product.predictedQuantity }}</td>
		</tr>
	</table>
	<!--<textarea id="comment" rows="5" cols="70"></textarea><br /><br />-->
	<!--<input type="button" id="add_status" value="Add Status">-->

</div>

<script>
	var socket = io();
	var app = angular.module('myApp', []);
	app.controller('customersCtrl', function ($scope, $http) {
		$http({
			url: 'https://kitchendisplaysystem.herokuapp.com/getKitchenData',
			method: 'GET'
		}).then(function (res) {
			$scope.kitchens = res.data.data[0].order.filter(function (p1, p2, p3) {
				if (p1.status != 1) {
					p1.produced = 0;
					return res.data.data[0].order.filter(function (data) {
						if (data.status == 1 && data.product._id == p1.product._id) {
							return p1.produced += parseInt(data.quantity);
						}
					});
				}
			});
		});
		//	url: 'https://kitchendisplaysystem.herokuapp.com/getKitchenData',
		$scope.report = function () {
			$http({
				url: 'https://kitchendisplaysystem.herokuapp.com/getKitchenData',
				method: 'GET'
			}).then(function (res) {
				var result = res.data.data[0].order.filter(function (p1) {
					if (p1.status == 1) {
						p1.produced = 0;
						return res.data.data[0].order.filter(function (data, index, self) {
							if (data.status == 1 && data.product._id == p1.product._id) {
								return p1.produced += parseInt(data.quantity);
							}
						});
					}
				});
				
				var obj = {};
				
				for ( var i=0, len=result.length; i < len; i++ )
					obj[result[i]['place']] = result[i];
				
				result = new Array();
				for ( var key in obj )
					result.push(obj[key]);
				
				
				$scope.kitchensRPT = result;
			});
		};
		
		$scope.orderDone = function (id) {
			socket.emit('status added', id);
		};
		
		socket.on('refresh feed', function (data) {
			$scope.$apply(function () {
				$scope.kitchens = data.order.filter(function (p1) {
					if (p1.status != 1) {
						p1.produced = 0;
						return data.order.filter(function (data) {
							if (data.status == 1 && data.product._id == p1.product._id) {
								return p1.produced += parseInt(data.quantity);
							}
						});
					}
				});
			});
		});
	});

</script>
</body>
</html>